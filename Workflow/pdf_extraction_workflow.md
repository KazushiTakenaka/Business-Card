# PDF名刺情報抽出ワークフロー

このドキュメントは、Google Drive上の名刺PDFから情報を抽出してGoogleスプレッドシートに登録するワークフローを説明します。

## 概要

このワークフローは3つのステップで構成されています：

1. **準備**: PDFをGoogle Driveからダウンロード
2. **処理**: Claude Codeが各PDFを読み取り、名刺情報を抽出してスプレッドシートに追加
3. **クリーンアップ**: ローカルファイルを削除、DriveファイルをProcessedフォルダに移動

## 前提条件

- Python仮想環境が有効化されている
- Google Drive APIとSheets APIへのアクセス権限がある
- サービスアカウントキーが設定されている

## 完全なワークフロー

### ステップ1: 環境準備

```bash
# 仮想環境を有効化
.\.venv\Scripts\activate.ps1

# メインプログラムを起動
python .\PyPrograms\main.py
```

### ステップ2: PDF処理準備

メニューで **「5」** を選択

**処理内容:**
- Google DriveフォルダからすべてのPDFファイルを取得
- 各PDFをローカルの`temp_pdfs/`ディレクトリにダウンロード
- メタデータを`processing_data.json`に保存

**出力例:**
```
============================================================
ステップ1: PDFダウンロードと準備
============================================================

Google DriveからPDFファイルリストを取得中...
33個のPDFファイルが見つかりました。

[1/33] ダウンロード中: スキャン_20251217-0754.pdf
  保存完了: temp_pdfs/スキャン_20251217-0754.pdf
[2/33] ダウンロード中: スキャン_20251118-1425.pdf
  保存完了: temp_pdfs/スキャン_20251118-1425.pdf
...

============================================================
準備完了！33個のPDFをダウンロードしました。
============================================================
```

**次のステップの指示が表示されます:**
```
次のステップ:
1. Claude Codeに以下のように依頼してください:
   「temp_pdfs/内の全PDFから名刺情報を抽出して、
    extracted_business_cards.jsonに保存してください」

2. JSONファイルをスプレッドシートに追加:
   python PyPrograms/main.py
   # メニューで「7」を選択
   または: python PyPrograms/add_cards_batch.py extracted_business_cards.json

3. 処理完了後、以下のコマンドでクリーンアップを実行:
   python PyPrograms/extract_and_upload_to_sheet.py --cleanup
   または: python PyPrograms/main.py でメニュー「6」を選択
```

### ステップ3: PDFから名刺情報を抽出

Claude Codeに以下のように依頼します：

```
temp_pdfs/内の全PDFから名刺情報を抽出して、
extracted_business_cards.jsonに保存してください
```

**Claude Codeの処理:**
1. `temp_pdfs/`ディレクトリ内の各PDFファイルを読み取り
2. PDFに含まれる名刺情報を解析（複数枚の名刺が含まれる場合も対応）
3. 以下の情報を抽出：
   - 氏名（漢字）
   - 氏名（ローマ字）
   - 会社名
   - 役職
   - メールアドレス
   - 携帯電話
   - 固定電話
   - FAX
   - 郵便番号
   - 住所
   - ウェブサイト
   - LINE ID
   - その他SNS
   - 備考
   - スキャンファイル名（自動記録）
4. `extracted_business_cards.json`として保存

**JSONファイル形式（配列形式）:**
```json
[
  {
    "filename": "スキャン_20251217-0754.pdf",
    "氏名(漢字)": "山田 太郎",
    "氏名(ローマ字)": "Yamada Taro",
    "会社名": "株式会社サンプル",
    "役職": "代表取締役",
    "メールアドレス": "yamada@example.com",
    "携帯電話": "090-1234-5678",
    "固定電話": "03-1234-5678",
    "FAX": "03-1234-5679",
    "郵便番号": "100-0001",
    "住所": "東京都千代田区千代田1-1-1",
    "ウェブサイト": "https://example.com",
    "LINE ID": "",
    "その他SNS": "",
    "備考": ""
  },
  {
    "filename": "スキャン_20251217-0754.pdf",
    "氏名(漢字)": "佐藤 花子",
    "氏名(ローマ字)": "Sato Hanako",
    ...
  }
]
```

**重要な仕様:**
- **読み取り日の自動抽出**: ファイル名（例: `スキャン_20251217-0754.pdf`）から日付（`2025-12-17`）を自動的に抽出してスプレッドシートに記録します
- **複数名刺対応**: 1つのPDFに複数枚の名刺が含まれる場合、すべて個別のオブジェクトとして記録されます

### ステップ4: JSONファイルをスプレッドシートに追加

抽出した`extracted_business_cards.json`をスプレッドシートに追加します：

**メニューから実行:**
```bash
python PyPrograms/main.py
# メニューで「7」を選択
# JSONファイルのパスを入力: extracted_business_cards.json
```

**またはコマンドラインから:**
```bash
python PyPrograms/add_cards_batch.py extracted_business_cards.json
```

**処理内容:**
- JSONファイルから名刺データを読み込み（配列形式と従来形式の両方に対応）
- ファイル名から読み取り日を自動抽出（例: `スキャン_20250803-0909-2.pdf` → `2025-08-03`）
- Googleスプレッドシート（ID: `1lN-ClkkRDO9wdcv8IPWXrRTcHjaQC5kiFC3mHxi2jWA`）に各行を追加
- エラーが発生した名刺のみを表示（再試行可能）

**出力例:**
```
============================================================
名刺データ一括追加
============================================================

読み込み元PDF: 一括登録
名刺データ数: 18件

スプレッドシートに追加しますか？ (y/n): y

[1/18] 追加完了: 後藤 一徳 (HKテクノロジー株式会社)
[2/18] 追加完了: 馬場 勇郎 (株式会社ゼンユー)
[3/18] 追加完了: 藤島 涼 (株式会社ゼンユー)
...

============================================================
処理完了: 成功 18件, エラー 0件
============================================================
```

**この方法の利点:**
- 複数枚の名刺が含まれるPDFに対応
- エラーハンドリングと再試行が容易
- JSONファイル名が固定（`extracted_business_cards.json`）なので、毎回同じコマンドで実行可能
- 処理状況が明確に表示される
- ファイル名から読み取り日を自動抽出

### ステップ5: クリーンアップ

メインメニューに戻り、**「6」** を選択

**処理内容:**
- `temp_pdfs/`ディレクトリ内のすべてのPDFファイルを削除
- Google Drive上の元PDFファイルを「読み取り済データ」フォルダ（ID: `1Ddb0n_BYW35KMU-nzKzZfrv8c5oBccNe`）に移動
- `processing_data.json`を削除
- `extracted_business_cards.json`を削除
- `temp_pdfs/`ディレクトリを削除（空の場合）

**確認プロンプト:**
```
17個のファイルをクリーンアップします。

続行しますか？ (y/n):
```

**出力例:**
```
============================================================
ステップ3: クリーンアップ処理
============================================================

17個のファイルをクリーンアップします。

続行しますか？ (y/n): y

[1/17] 処理中: スキャン_20250803-090-1.pdf
  ローカルファイルを削除: temp_pdfs/スキャン_20250803-090-1.pdf
  Driveファイルを移動: スキャン_20250803-090-1.pdf → 読み取り済データ
[2/17] 処理中: スキャン_20250803-0906-1.pdf
  ローカルファイルを削除: temp_pdfs/スキャン_20250803-0906-1.pdf
  Driveファイルを移動: スキャン_20250803-0906-1.pdf → 読み取り済データ
...

一時ディレクトリを削除: temp_pdfs
メタデータファイルを削除: processing_data.json
抽出済みJSONファイルを削除: extracted_business_cards.json

============================================================
クリーンアップ完了！
============================================================
```

## コマンドライン版

メニューを使わずにコマンドラインから直接実行することもできます。

### 準備

```bash
python PyPrograms/extract_and_upload_to_sheet.py
```

### クリーンアップ

```bash
python PyPrograms/extract_and_upload_to_sheet.py --cleanup
```

## ファイル構成

ワークフロー実行時に生成されるファイル・ディレクトリ：

```
名刺/
├── temp_pdfs/                       # 一時PDFディレクトリ（処理中のみ）
│   ├── スキャン_20250803-090-1.pdf
│   ├── スキャン_20250803-0906-1.pdf
│   └── ...
├── processing_data.json             # メタデータファイル（処理中のみ）
└── extracted_business_cards.json    # 抽出した名刺データ（処理中のみ）
```

### processing_data.json の構造

```json
[
  {
    "file_name": "スキャン_20251217-0754.pdf",
    "file_id": "16wRJkYYUxR8AzcIUtPyRr_gp50cCWXy-",
    "local_path": "temp_pdfs/スキャン_20251217-0754.pdf",
    "processed": false
  },
  ...
]
```

## Google Drive フォルダ構成

```
名刺フォルダ (1eS10Nev-HfnisoY-sPEvephLBQ2h37Lu)
├── スキャン_*.pdf              # 未処理のPDF（処理前）
└── 読み取り済データ/            # 処理済みPDFの移動先
    └── スキャン_*.pdf          # 処理済みのPDF（処理後）
```

## トラブルシューティング

### PDFダウンロードエラー

**症状:** ダウンロード中にエラーが発生する

**対処法:**
- インターネット接続を確認
- サービスアカウントの権限を確認
- Google Drive APIの制限を確認

### スプレッドシート書き込みエラー

**症状:** スプレッドシートに書き込めない

**対処法:**
- サービスアカウントにスプレッドシートの編集権限があることを確認
- `config.py`の`SCOPES_SHEETS_READWRITE`が正しく設定されていることを確認

### クリーンアップ中断

**症状:** クリーンアップが途中で中断された

**対処法:**
- `processing_data.json`を確認
- 手動で残りのファイルを削除・移動
- または再度クリーンアップを実行（べき等性があるため安全）

## 注意事項

1. **データバックアップ**: 重要なPDFは事前にバックアップを取ってください
2. **処理時間**: PDFファイル数が多い場合、処理に時間がかかります
3. **API制限**: Google APIの使用制限に注意してください
4. **重複チェック**: 同じPDFを複数回処理しないように注意してください
5. **複数枚名刺**: 1つのPDFに複数枚の名刺が含まれる場合があります。配列形式のJSONを使用することで、すべての名刺を確実に追加できます
6. **固定ファイル名**: 抽出したJSONファイルは常に`extracted_business_cards.json`という名前で保存されます。クリーンアップ時に自動的に削除されます
7. **読み取り日の自動抽出**: ファイル名から日付が自動的に抽出されます（形式: `スキャン_YYYYMMDD-HHMM-N.pdf` → `YYYY-MM-DD`）

## 関連ファイル

- `PyPrograms/extract_and_upload_to_sheet.py` - PDF準備とクリーンアップスクリプト
- `PyPrograms/add_cards_batch.py` - JSONファイルから名刺を一括追加するスクリプト
- `PyPrograms/utils.py` - ユーティリティ関数
- `PyPrograms/config.py` - 設定ファイル
- `PyPrograms/main.py` - メニューインターフェース
- `PyPrograms/card_data_template.json` - JSONテンプレートファイル
- `PyPrograms/example_cards.json` - JSON形式の例

## 更新履歴

- 2025-12-19: 初版作成
- 2025-12-19: JSONファイルを使った一括追加方法を追加、複数枚名刺対応
- 2025-12-19: JSONファイル名を`extracted_business_cards.json`に固定、配列形式に変更、読み取り日の自動抽出機能を追加、クリーンアップ時にJSONも削除するよう改善
