# PDF名刺情報抽出ワークフロー

このドキュメントは、Google Drive上の名刺PDFから情報を抽出してGoogleスプレッドシートに登録するワークフローを説明します。

## 概要

このワークフローは3つのステップで構成されています：

1. **準備**: PDFをGoogle Driveからダウンロード
2. **処理**: Claude Codeが各PDFを読み取り、名刺情報を抽出してスプレッドシートに追加
3. **クリーンアップ**: ローカルファイルを削除、DriveファイルをProcessedフォルダに移動

## 前提条件

- Python仮想環境が有効化されている
- Google Drive APIとSheets APIへのアクセス権限がある
- サービスアカウントキーが設定されている

## 完全なワークフロー

### ステップ1: 環境準備

```bash
# 仮想環境を有効化
.\.venv\Scripts\activate.ps1

# メインプログラムを起動
python .\PyPrograms\main.py
```

### ステップ2: PDF処理準備

メニューで **「5」** を選択

**処理内容:**
- Google DriveフォルダからすべてのPDFファイルを取得
- 各PDFをローカルの`temp_pdfs/`ディレクトリにダウンロード
- メタデータを`processing_data.json`に保存

**出力例:**
```
============================================================
ステップ1: PDFダウンロードと準備
============================================================

Google DriveからPDFファイルリストを取得中...
33個のPDFファイルが見つかりました。

[1/33] ダウンロード中: スキャン_20251217-0754.pdf
  保存完了: temp_pdfs/スキャン_20251217-0754.pdf
[2/33] ダウンロード中: スキャン_20251118-1425.pdf
  保存完了: temp_pdfs/スキャン_20251118-1425.pdf
...

============================================================
準備完了！33個のPDFをダウンロードしました。
============================================================
```

**次のステップの指示が表示されます:**
```
次のステップ:
1. Claude Codeに以下のように依頼してください:
   「temp_pdfs/内の全PDFから名刺情報を抽出して、
    JSONファイルに保存してください」

2. JSONファイルをスプレッドシートに追加:
   python PyPrograms/main.py
   # メニューで「7」を選択

3. 処理完了後、以下のコマンドでクリーンアップを実行:
   python PyPrograms/extract_and_upload_to_sheet.py --cleanup
```

### ステップ3: PDFから名刺情報を抽出

#### 方法A: Claude Codeに直接依頼（従来の方法）

Claude Codeに以下のように依頼します：

```
temp_pdfs/内の全PDFから名刺情報を抽出して、
JSONファイルに保存してください
```

**Claude Codeの処理:**
1. `temp_pdfs/`ディレクトリ内の各PDFファイルを読み取り
2. PDFに含まれる名刺情報を解析（複数枚の名刺が含まれる場合も対応）
3. 以下の情報を抽出：
   - 氏名（漢字）
   - 氏名（ローマ字）
   - 会社名
   - 役職
   - メールアドレス
   - 携帯電話
   - 固定電話
   - FAX
   - 郵便番号
   - 住所
   - ウェブサイト
   - LINE ID
   - その他SNS
   - 備考
4. JSONファイル形式で保存

**JSONファイル例:**
```json
{
  "source_pdf": "スキャン_20251217-0754.pdf",
  "cards": [
    ["山田太郎", "Taro Yamada", "株式会社サンプル", "代表取締役", "yamada@example.com", "090-1234-5678", "03-1234-5678", "03-1234-5679", "100-0001", "東京都千代田区千代田1-1-1", "https://example.com", "", "", "備考"],
    ["佐藤花子", "Hanako Sato", "サンプル株式会社", ...]
  ]
}
```

#### 方法B: JSONファイルから一括追加（推奨）

抽出したJSONファイルをスプレッドシートに追加します：

**メニューから実行:**
```bash
python PyPrograms/main.py
# メニューで「7」を選択
# JSONファイルのパスを入力
```

**またはコマンドラインから:**
```bash
python PyPrograms/add_cards_batch.py cards.json
```

**処理内容:**
- JSONファイルから名刺データを読み込み
- スキャンファイル名と読み取り日を自動追加
- Googleスプレッドシート（ID: `1lN-ClkkRDO9wdcv8IPWXrRTcHjaQC5kiFC3mHxi2jWA`）に各行を追加
- エラーが発生した名刺のみを表示（再試行可能）

**出力例:**
```
============================================================
名刺データ一括追加
============================================================

読み込み元PDF: スキャン_20251217-0754.pdf
名刺データ数: 11件

スプレッドシートに追加しますか？ (y/n): y

[1/11] 追加完了: 濱崎 浩司 (株式会社アーストレックロボティクス)
[2/11] 追加完了: 吉田周司 (delight design)
[3/11] 追加完了: 溝口 聡志 (Gallery Goro)
...

============================================================
処理完了: 成功 11件, エラー 0件
============================================================
```

**方法Bの利点:**
- 複数枚の名刺が含まれるPDFに対応
- エラーハンドリングと再試行が容易
- JSONファイルを保存すれば、後から再実行可能
- 処理状況が明確に表示される

### ステップ4: クリーンアップ

メインメニューに戻り、**「6」** を選択

**処理内容:**
- `temp_pdfs/`ディレクトリ内のすべてのPDFファイルを削除
- Google Drive上の元PDFファイルを「読み取り済データ」フォルダ（ID: `1Ddb0n_BYW35KMU-nzKzZfrv8c5oBccNe`）に移動
- `processing_data.json`を削除
- `temp_pdfs/`ディレクトリを削除（空の場合）

**確認プロンプト:**
```
33個のファイルをクリーンアップします。

続行しますか？ (y/n):
```

**出力例:**
```
============================================================
ステップ3: クリーンアップ処理
============================================================

33個のファイルをクリーンアップします。

続行しますか？ (y/n): y

[1/33] 処理中: スキャン_20251217-0754.pdf
  ローカルファイルを削除: temp_pdfs/スキャン_20251217-0754.pdf
  Driveファイルを移動: スキャン_20251217-0754.pdf → 読み取り済データ
[2/33] 処理中: スキャン_20251118-1425.pdf
  ローカルファイルを削除: temp_pdfs/スキャン_20251118-1425.pdf
  Driveファイルを移動: スキャン_20251118-1425.pdf → 読み取り済データ
...

一時ディレクトリを削除: temp_pdfs
メタデータファイルを削除: processing_data.json

============================================================
クリーンアップ完了！
============================================================
```

## コマンドライン版

メニューを使わずにコマンドラインから直接実行することもできます。

### 準備

```bash
python PyPrograms/extract_and_upload_to_sheet.py
```

### クリーンアップ

```bash
python PyPrograms/extract_and_upload_to_sheet.py --cleanup
```

## ファイル構成

ワークフロー実行時に生成されるファイル・ディレクトリ：

```
名刺/
├── temp_pdfs/                    # 一時PDFディレクトリ（処理中のみ）
│   ├── スキャン_20251217-0754.pdf
│   ├── スキャン_20251118-1425.pdf
│   └── ...
└── processing_data.json          # メタデータファイル（処理中のみ）
```

### processing_data.json の構造

```json
[
  {
    "file_name": "スキャン_20251217-0754.pdf",
    "file_id": "16wRJkYYUxR8AzcIUtPyRr_gp50cCWXy-",
    "local_path": "temp_pdfs/スキャン_20251217-0754.pdf",
    "processed": false
  },
  ...
]
```

## Google Drive フォルダ構成

```
名刺フォルダ (1eS10Nev-HfnisoY-sPEvephLBQ2h37Lu)
├── スキャン_*.pdf              # 未処理のPDF（処理前）
└── 読み取り済データ/            # 処理済みPDFの移動先
    └── スキャン_*.pdf          # 処理済みのPDF（処理後）
```

## トラブルシューティング

### PDFダウンロードエラー

**症状:** ダウンロード中にエラーが発生する

**対処法:**
- インターネット接続を確認
- サービスアカウントの権限を確認
- Google Drive APIの制限を確認

### スプレッドシート書き込みエラー

**症状:** スプレッドシートに書き込めない

**対処法:**
- サービスアカウントにスプレッドシートの編集権限があることを確認
- `config.py`の`SCOPES_SHEETS_READWRITE`が正しく設定されていることを確認

### クリーンアップ中断

**症状:** クリーンアップが途中で中断された

**対処法:**
- `processing_data.json`を確認
- 手動で残りのファイルを削除・移動
- または再度クリーンアップを実行（べき等性があるため安全）

## 注意事項

1. **データバックアップ**: 重要なPDFは事前にバックアップを取ってください
2. **処理時間**: PDFファイル数が多い場合、処理に時間がかかります
3. **API制限**: Google APIの使用制限に注意してください
4. **重複チェック**: 同じPDFを複数回処理しないように注意してください
5. **複数枚名刺**: 1つのPDFに複数枚の名刺が含まれる場合があります。JSONファイル形式を使用することで、すべての名刺を確実に追加できます
6. **JSONファイルの保存**: 抽出したJSONファイルは保存しておくことをお勧めします。エラーが発生した場合に再実行できます

## 関連ファイル

- `PyPrograms/extract_and_upload_to_sheet.py` - PDF準備とクリーンアップスクリプト
- `PyPrograms/add_cards_batch.py` - JSONファイルから名刺を一括追加するスクリプト
- `PyPrograms/utils.py` - ユーティリティ関数
- `PyPrograms/config.py` - 設定ファイル
- `PyPrograms/main.py` - メニューインターフェース
- `PyPrograms/card_data_template.json` - JSONテンプレートファイル
- `PyPrograms/example_cards.json` - JSON形式の例

## 更新履歴

- 2025-12-19: 初版作成
- 2025-12-19: JSONファイルを使った一括追加方法を追加、複数枚名刺対応
