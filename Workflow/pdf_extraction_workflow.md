# PDF名刺情報抽出ワークフロー

このドキュメントは、Google Drive上の名刺PDFから情報を抽出してGoogleスプレッドシートに登録するワークフローを説明します。

## 概要

このワークフローは3つのステップで構成されています：

1. **準備**: PDFをGoogle Driveからダウンロード
2. **処理**: Claude Codeが各PDFを読み取り、名刺情報を抽出してスプレッドシートに追加
3. **クリーンアップ**: ローカルファイルを削除、DriveファイルをProcessedフォルダに移動

## 前提条件

- Python仮想環境が有効化されている
- Google Drive APIとSheets APIへのアクセス権限がある
- サービスアカウントキーが設定されている

## 完全なワークフロー

### ステップ1: 環境準備

```bash
# 仮想環境を有効化
.venv\Scripts\activate

# メインプログラムを起動
python PyPrograms/main.py
```

### ステップ2: PDF処理準備

メニューで **「5」** を選択

**処理内容:**
- Google DriveフォルダからすべてのPDFファイルを取得
- 各PDFをローカルの`temp_pdfs/`ディレクトリにダウンロード
- メタデータを`processing_data.json`に保存

**出力例:**
```
============================================================
ステップ1: PDFダウンロードと準備
============================================================

Google DriveからPDFファイルリストを取得中...
33個のPDFファイルが見つかりました。

[1/33] ダウンロード中: スキャン_20251217-0754.pdf
  保存完了: temp_pdfs/スキャン_20251217-0754.pdf
[2/33] ダウンロード中: スキャン_20251118-1425.pdf
  保存完了: temp_pdfs/スキャン_20251118-1425.pdf
...

============================================================
準備完了！33個のPDFをダウンロードしました。
============================================================
```

**次のステップの指示が表示されます:**
```
次のステップ:
1. Claude Codeに以下のように依頼してください:
   「temp_pdfs/内の全PDFから名刺情報を抽出して、
    スプレッドシートに追加してください」

2. 処理完了後、以下のコマンドでクリーンアップを実行:
   python PyPrograms/extract_and_upload_to_sheet.py --cleanup
```

### ステップ3: PDFから名刺情報を抽出

Claude Codeに以下のように依頼します：

```
temp_pdfs/内の全PDFから名刺情報を抽出して、
スプレッドシートに追加してください
```

**Claude Codeの処理:**
1. `temp_pdfs/`ディレクトリ内の各PDFファイルを読み取り
2. PDFに含まれる名刺情報を解析
3. 以下の情報を抽出：
   - 氏名（漢字）
   - 氏名（ローマ字）
   - 会社名
   - 役職
   - メールアドレス
   - 携帯電話
   - 固定電話
   - FAX
   - 郵便番号
   - 住所
   - ウェブサイト
   - LINE ID
   - その他SNS
   - 備考
   - スキャンファイル名
   - 読み取り日
4. Googleスプレッドシート（ID: `1lN-ClkkRDO9wdcv8IPWXrRTcHjaQC5kiFC3mHxi2jWA`）に各行を追加

### ステップ4: クリーンアップ

メインメニューに戻り、**「6」** を選択

**処理内容:**
- `temp_pdfs/`ディレクトリ内のすべてのPDFファイルを削除
- Google Drive上の元PDFファイルを「読み取り済データ」フォルダ（ID: `1Ddb0n_BYW35KMU-nzKzZfrv8c5oBccNe`）に移動
- `processing_data.json`を削除
- `temp_pdfs/`ディレクトリを削除（空の場合）

**確認プロンプト:**
```
33個のファイルをクリーンアップします。

続行しますか？ (y/n):
```

**出力例:**
```
============================================================
ステップ3: クリーンアップ処理
============================================================

33個のファイルをクリーンアップします。

続行しますか？ (y/n): y

[1/33] 処理中: スキャン_20251217-0754.pdf
  ローカルファイルを削除: temp_pdfs/スキャン_20251217-0754.pdf
  Driveファイルを移動: スキャン_20251217-0754.pdf → 読み取り済データ
[2/33] 処理中: スキャン_20251118-1425.pdf
  ローカルファイルを削除: temp_pdfs/スキャン_20251118-1425.pdf
  Driveファイルを移動: スキャン_20251118-1425.pdf → 読み取り済データ
...

一時ディレクトリを削除: temp_pdfs
メタデータファイルを削除: processing_data.json

============================================================
クリーンアップ完了！
============================================================
```

## コマンドライン版

メニューを使わずにコマンドラインから直接実行することもできます。

### 準備

```bash
python PyPrograms/extract_and_upload_to_sheet.py
```

### クリーンアップ

```bash
python PyPrograms/extract_and_upload_to_sheet.py --cleanup
```

## ファイル構成

ワークフロー実行時に生成されるファイル・ディレクトリ：

```
名刺/
├── temp_pdfs/                    # 一時PDFディレクトリ（処理中のみ）
│   ├── スキャン_20251217-0754.pdf
│   ├── スキャン_20251118-1425.pdf
│   └── ...
└── processing_data.json          # メタデータファイル（処理中のみ）
```

### processing_data.json の構造

```json
[
  {
    "file_name": "スキャン_20251217-0754.pdf",
    "file_id": "16wRJkYYUxR8AzcIUtPyRr_gp50cCWXy-",
    "local_path": "temp_pdfs/スキャン_20251217-0754.pdf",
    "processed": false
  },
  ...
]
```

## Google Drive フォルダ構成

```
名刺フォルダ (1eS10Nev-HfnisoY-sPEvephLBQ2h37Lu)
├── スキャン_*.pdf              # 未処理のPDF（処理前）
└── 読み取り済データ/            # 処理済みPDFの移動先
    └── スキャン_*.pdf          # 処理済みのPDF（処理後）
```

## トラブルシューティング

### PDFダウンロードエラー

**症状:** ダウンロード中にエラーが発生する

**対処法:**
- インターネット接続を確認
- サービスアカウントの権限を確認
- Google Drive APIの制限を確認

### スプレッドシート書き込みエラー

**症状:** スプレッドシートに書き込めない

**対処法:**
- サービスアカウントにスプレッドシートの編集権限があることを確認
- `config.py`の`SCOPES_SHEETS_READWRITE`が正しく設定されていることを確認

### クリーンアップ中断

**症状:** クリーンアップが途中で中断された

**対処法:**
- `processing_data.json`を確認
- 手動で残りのファイルを削除・移動
- または再度クリーンアップを実行（べき等性があるため安全）

## 注意事項

1. **データバックアップ**: 重要なPDFは事前にバックアップを取ってください
2. **処理時間**: PDFファイル数が多い場合、処理に時間がかかります
3. **API制限**: Google APIの使用制限に注意してください
4. **重複チェック**: 同じPDFを複数回処理しないように注意してください

## 関連ファイル

- `PyPrograms/extract_and_upload_to_sheet.py` - メインスクリプト
- `PyPrograms/utils.py` - ユーティリティ関数
- `PyPrograms/config.py` - 設定ファイル
- `PyPrograms/main.py` - メニューインターフェース

## 更新履歴

- 2025-12-19: 初版作成
